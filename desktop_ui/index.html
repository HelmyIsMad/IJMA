<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IJMA Document Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <style>
    .form-section {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section-title {
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <span class="navbar-brand"><strong>IJMA Document Generator</strong></span>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <div class="col-lg-10 mx-auto">
        <h1 class="text-center mb-4">IJMA Document Generator</h1>

        <div id="status-area"></div>

        <form id="ijma-form" enctype="multipart/form-data">
          <!-- HTML Import Section -->
          <div class="form-section">
            <h3 class="section-title">Import from HTML (Optional)</h3>
            <div class="mb-3">
              <label for="html_paste" class="form-label">Paste IJMA Submission HTML</label>
              <textarea class="form-control" id="html_paste" rows="6" placeholder="Paste the HTML from the IJMA submission page here, then click Parse HTML..."></textarea>
              <small class="text-muted">This will auto-fill title, dates, authors, and affiliations.</small>
            </div>
            <button type="button" class="btn btn-success" onclick="parseHTMLPaste()">Parse HTML</button>

            <div id="corresponding-author-selection" style="display: none; margin-top: 20px;">
              <h6>Select Corresponding Author:</h6>
              <div id="corresponding-author-radios"></div>
              <button type="button" class="btn btn-primary btn-sm mt-2" onclick="applyScrapedData()">Apply to Form</button>
            </div>
          </div>

          <!-- Basic Information Section -->
          <div class="form-section">
            <h3 class="section-title">Basic Information</h3>

            <div class="mb-3">
              <label for="manuscript_code" class="form-label">Manuscript Code</label>
              <input type="text" class="form-control" id="manuscript_code" name="manuscript_code" placeholder="e.g., IJMA-2024-12345">
              <small class="text-muted">Optional: Submission tracking code</small>
            </div>

            <div class="mb-3">
              <label for="research_title" class="form-label">Research Title *</label>
              <input type="text" class="form-control" id="research_title" name="research_title" required>
            </div>

            <div class="mb-3">
              <label for="research_type" class="form-label">Research Type</label>
              <input type="text" class="form-control" id="research_type" name="research_type" placeholder="e.g., Original Article, Case Report, Review, etc.">
            </div>

            <div class="row">
              <div class="col-md-6">
                <label for="receive_date" class="form-label">Received Date</label>
                <input type="text" class="form-control" id="receive_date" name="receive_date" placeholder="e.g., 15 January 2024">
              </div>
              <div class="col-md-6">
                <label for="accept_date" class="form-label">Accepted Date</label>
                <input type="text" class="form-control" id="accept_date" name="accept_date" placeholder="e.g., 28 February 2024">
              </div>
            </div>
          </div>

          <!-- Authors Section -->
          <div class="form-section">
            <h3 class="section-title">Authors & Affiliations</h3>
            <div id="authors-container">
              <div class="author-group mb-4 border rounded p-3" style="background-color: #fff;">
                <h6 class="text-primary">Author 1</h6>
                <div class="row">
                  <div class="col-md-4">
                    <label for="author_name_1" class="form-label">Author Name *</label>
                    <input type="text" class="form-control" id="author_name_1" name="author_name_1" required>
                  </div>
                  <div class="col-md-4">
                    <label for="author_affiliation_1" class="form-label">Affiliation</label>
                    <textarea class="form-control" id="author_affiliation_1" name="author_affiliation_1" rows="2"></textarea>
                  </div>
                  <div class="col-md-4">
                    <label for="author_email_1" class="form-label">Email (Corresponding Author)</label>
                    <input type="email" class="form-control" id="author_email_1" name="author_email_1">
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAuthor()">
              <i class="bi bi-plus"></i> Add Author
            </button>
          </div>

          <!-- Content Sections -->
          <div class="form-section">
            <h3 class="section-title">Abstract & Keywords</h3>

            <div class="mb-3">
              <label for="abstract" class="form-label">Abstract</label>
              <textarea class="form-control" id="abstract" name="abstract" rows="8" placeholder="Write your abstract here..."></textarea>
            </div>

            <div class="mb-3">
              <label for="keywords" class="form-label">Keywords</label>
              <input type="text" class="form-control" id="keywords" name="keywords" placeholder="Keyword 1; Keyword 2; Keyword 3">
            </div>
          </div>

          <!-- Research Content -->
          <div class="form-section">
            <h3 class="section-title">Research Content</h3>

            <div class="mb-3">
              <label for="introduction" class="form-label">Introduction</label>
              <textarea class="form-control" id="introduction" name="introduction" rows="6" placeholder="Write your introduction here..."></textarea>
            </div>

            <div class="mb-3">
              <label for="aim_of_work" class="form-label">Aim of the Work</label>
              <textarea class="form-control" id="aim_of_work" name="aim_of_work" rows="4" placeholder="Describe the aim of your work..."></textarea>
            </div>

            <div class="mb-3">
              <label for="patients_methods" class="form-label">Patients and Methods</label>
              <textarea class="form-control" id="patients_methods" name="patients_methods" rows="6" placeholder="Describe your methodology..."></textarea>
            </div>

            <div class="mb-3">
              <label for="results" class="form-label">Results</label>
              <textarea class="form-control" id="results" name="results" rows="6" placeholder="Present your results..."></textarea>
            </div>
          </div>

          <!-- Tables Section -->
          <div class="form-section">
            <h3 class="section-title">Tables</h3>
            <div id="tables-container">
              <div class="table-group mb-4 border rounded p-3" style="background-color: #fff;">
                <h6 class="text-success">Table 1</h6>
                <div class="mb-3">
                  <label for="table_info_1" class="form-label">Table Caption/Description</label>
                  <input type="text" class="form-control" id="table_info_1" name="table_info_1" placeholder="Table 1: Description of the table...">
                </div>
                <div class="mb-3">
                  <label for="table_content_1" class="form-label">Table Content (Paste from Word)</label>
                  <div class="table-paste-area border rounded p-2" contenteditable="true" id="table_content_1" data-target="table_content_1_hidden" style="background-color: #fff; overflow: hidden;" placeholder="Paste your table here from Word - it will preserve formatting and structure"></div>
                  <input type="hidden" id="table_content_1_hidden" name="table_content_1" />
                  <small class="text-muted">Copy your table from Word and paste it here. The table structure will be preserved.</small>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-outline-success btn-sm" onclick="addTable()">
              <i class="bi bi-plus"></i> Add Table
            </button>
          </div>

          <!-- Figures Section -->
          <div class="form-section">
            <h3 class="section-title">Figures</h3>
            <div id="figures-container">
              <div class="figure-group mb-4 border rounded p-3" style="background-color: #fff;">
                <h6 class="text-warning">Figure 1</h6>
                <div class="mb-3">
                  <label for="figure_info_1" class="form-label">Figure Caption/Description</label>
                  <input type="text" class="form-control" id="figure_info_1" name="figure_info_1" placeholder="Figure 1: Description of the figure...">
                </div>
                <div class="mb-3">
                  <label for="figure_content_1" class="form-label">Figure Content (Paste from Word)</label>
                  <div class="figure-paste-area border rounded p-2" contenteditable="true" id="figure_content_1" data-target="figure_content_1_hidden" style="background-color: #fff; overflow: hidden;" placeholder="Paste your figure/image here from Word - images will be preserved"></div>
                  <input type="hidden" id="figure_content_1_hidden" name="figure_content_1" />
                  <small class="text-muted">Copy your figure/image from Word and paste it here. Images will be preserved.</small>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-outline-warning btn-sm" onclick="addFigure()">
              <i class="bi bi-plus"></i> Add Figure
            </button>
          </div>

          <!-- Discussion & References -->
          <div class="form-section">
            <h3 class="section-title">Discussion & References</h3>

            <div class="mb-3">
              <label for="discussion" class="form-label">Discussion</label>
              <textarea class="form-control" id="discussion" name="discussion" rows="8" placeholder="Write your discussion here..."></textarea>
            </div>

            <div class="mb-3">
              <label for="references" class="form-label">References</label>
              <textarea class="form-control" id="references" name="references" rows="10" placeholder="List your references here...&#10;1. Author A, et al. Title. Journal. Year;Volume:Pages.&#10;2. Author B, et al. Title. Journal. Year;Volume:Pages."></textarea>
            </div>
          </div>

          <div class="text-center mb-5">
            <button type="button" id="generate-btn" class="btn btn-primary btn-lg px-5 me-3" onclick="generateDocument()">
              Generate Document
            </button>
            <button type="button" class="btn btn-outline-danger btn-lg px-5" onclick="clearForm()">
              Clear Form
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let authorCount = 1;
    let tableCount = 1;
    let figureCount = 1;

    function setStatus(kind, message) {
      const area = document.getElementById('status-area');
      if (!area) return;
      const cls = kind === 'error' ? 'alert-danger' : (kind === 'success' ? 'alert-success' : 'alert-info');
      area.innerHTML = `<div class="alert ${cls} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
    }

    function addAuthor() {
      authorCount++;
      const container = document.getElementById('authors-container');
      const div = document.createElement('div');
      div.className = 'author-group mb-4 border rounded p-3';
      div.style.backgroundColor = '#fff';
      div.innerHTML = `
        <h6 class="text-primary d-flex justify-content-between align-items-center">
          Author ${authorCount}
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAuthor(this)">Remove</button>
        </h6>
        <div class="row">
          <div class="col-md-6">
            <label for="author_name_${authorCount}" class="form-label">Author Name</label>
            <input type="text" class="form-control" id="author_name_${authorCount}" name="author_name_${authorCount}">
          </div>
          <div class="col-md-6">
            <label for="author_affiliation_${authorCount}" class="form-label">Affiliation</label>
            <textarea class="form-control" id="author_affiliation_${authorCount}" name="author_affiliation_${authorCount}" rows="2"></textarea>
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    function addTable() {
      tableCount++;
      const container = document.getElementById('tables-container');
      const div = document.createElement('div');
      div.className = 'table-group mb-4 border rounded p-3';
      div.style.backgroundColor = '#fff';
      div.innerHTML = `
        <h6 class="text-success d-flex justify-content-between align-items-center">
          Table ${tableCount}
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTable(this)">Remove</button>
        </h6>
        <div class="mb-3">
          <label for="table_info_${tableCount}" class="form-label">Table Caption/Description</label>
          <input type="text" class="form-control" id="table_info_${tableCount}" name="table_info_${tableCount}" placeholder="Table ${tableCount}: Description of the table...">
        </div>
        <div class="mb-3">
          <label for="table_content_${tableCount}" class="form-label">Table Content (Paste from Word)</label>
          <div class="table-paste-area border rounded p-2" contenteditable="true" id="table_content_${tableCount}" data-target="table_content_${tableCount}_hidden" style="background-color: #fff; overflow: hidden;" placeholder="Paste your table here from Word - it will preserve formatting and structure"></div>
          <input type="hidden" id="table_content_${tableCount}_hidden" name="table_content_${tableCount}" />
          <small class="text-muted">Copy your table from Word and paste it here. The table structure will be preserved.</small>
        </div>
      `;
      container.appendChild(div);
      setupPasteArea(`table_content_${tableCount}`);
      setTimeout(saveFormData, 100);
    }

    function addFigure() {
      figureCount++;
      const container = document.getElementById('figures-container');
      const div = document.createElement('div');
      div.className = 'figure-group mb-4 border rounded p-3';
      div.style.backgroundColor = '#fff';
      div.innerHTML = `
        <h6 class="text-warning d-flex justify-content-between align-items-center">
          Figure ${figureCount}
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFigure(this)">Remove</button>
        </h6>
        <div class="mb-3">
          <label for="figure_info_${figureCount}" class="form-label">Figure Caption/Description</label>
          <input type="text" class="form-control" id="figure_info_${figureCount}" name="figure_info_${figureCount}" placeholder="Figure ${figureCount}: Description of the figure...">
        </div>
        <div class="mb-3">
          <label for="figure_content_${figureCount}" class="form-label">Figure Content (Paste from Word)</label>
          <div class="figure-paste-area border rounded p-2" contenteditable="true" id="figure_content_${figureCount}" data-target="figure_content_${figureCount}_hidden" style="background-color: #fff; overflow: hidden;" placeholder="Paste your figure/image here from Word - images will be preserved"></div>
          <input type="hidden" id="figure_content_${figureCount}_hidden" name="figure_content_${figureCount}" />
          <small class="text-muted">Copy your figure/image from Word and paste it here. Images will be preserved.</small>
        </div>
      `;
      container.appendChild(div);
      setupPasteArea(`figure_content_${figureCount}`);
      setTimeout(saveFormData, 100);
    }

    function removeAuthor(button) { button.closest('.author-group').remove(); saveFormData(); }
    function removeTable(button) { button.closest('.table-group').remove(); saveFormData(); }
    function removeFigure(button) { button.closest('.figure-group').remove(); saveFormData(); }

    document.addEventListener('DOMContentLoaded', function () {
      loadFormData();
      setupPasteArea('table_content_1');
      setupPasteArea('figure_content_1');

      document.addEventListener('input', function (e) {
        if (e.target.classList && (e.target.classList.contains('table-paste-area') || e.target.classList.contains('figure-paste-area'))) {
          updateHiddenInput(e.target);
        }
      });

      document.addEventListener('paste', function (e) {
        if (e.target.classList && (e.target.classList.contains('table-paste-area') || e.target.classList.contains('figure-paste-area'))) {
          setTimeout(() => updateHiddenInput(e.target), 100);
        }
      });
    });

    function autoResizeEditable(el) {
      // Fit element height to its content
      // - reset height so it can shrink
      // - then set to scrollHeight
      el.style.height = 'auto';
      el.style.height = (el.scrollHeight || 0) + 'px';
    }

    function setupPasteArea(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        // Initial sizing
        setTimeout(() => autoResizeEditable(element), 0);

        element.addEventListener('input', function () {
          updateHiddenInput(this);
          autoResizeEditable(this);
        });
        element.addEventListener('paste', (e) => {
          setTimeout(async () => {
            await normalizeImages(element);
            updateHiddenInput(element);
            autoResizeEditable(element);
          }, 100);
        });
      }
    }

    async function updateHiddenInput(contentEditableElement) {
      const targetId = contentEditableElement.getAttribute('data-target');
      const hiddenInput = document.getElementById(targetId);
      if (!hiddenInput) return;

      let content = contentEditableElement.innerHTML;

      if (contentEditableElement.classList.contains('table-paste-area')) {
        if (content.toLowerCase().includes('<table')) {
          hiddenInput.value = content;
          return;
        }
        const tableData = extractTableAsArray(contentEditableElement);
        if (tableData.length > 0) {
          hiddenInput.value = JSON.stringify(tableData);
          return;
        }
      }

      await normalizeImages(contentEditableElement);
      content = contentEditableElement.innerHTML;
      content = content.replace(/<div><br><\/div>/g, '\n');
      content = content.replace(/<div>/g, '\n');
      content = content.replace(/<\/div>/g, '');
      content = content.replace(/<br>/g, '\n');

      if (content.toLowerCase().includes('<img') || content.toLowerCase().includes('<table')) {
        hiddenInput.value = content;
      } else {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        hiddenInput.value = tempDiv.textContent || tempDiv.innerText || '';
      }

      return;
    }

    async function normalizeImages(container) {
      const imgNodes = Array.from(container.querySelectorAll('img'));
      const conversions = imgNodes.map(async (img) => {
        try {
          const src = img.getAttribute('src') || '';
          if (!src) return;
          if (src.startsWith('data:image/')) return;

          // blob: URLs (Clipboard) => inline via fetch
          if (src.startsWith('blob:')) {
            const response = await fetch(src);
            const blob = await response.blob();
            const dataUrl = await blobToDataURL(blob);
            img.setAttribute('src', dataUrl);
            return;
          }

          // http(s) => inline via fetch (best-effort)
          if (src.startsWith('http://') || src.startsWith('https://')) {
            const response = await fetch(src);
            const blob = await response.blob();
            const dataUrl = await blobToDataURL(blob);
            img.setAttribute('src', dataUrl);
            return;
          }

          // file:// (common when pasting from Word) => ask Python to read and convert
          if (src.startsWith('file:')) {
            if (window.pywebview && window.pywebview.api && window.pywebview.api.file_url_to_data_url) {
              const res = await window.pywebview.api.file_url_to_data_url(src);
              if (res && res.data_url) {
                img.setAttribute('src', res.data_url);
              } else {
                console.warn('file_url_to_data_url failed', res);
              }
            }
            return;
          }
        } catch (err) {
          console.warn('normalizeImages: failed to inline image', err);
        }
      });
      await Promise.all(conversions);
    }

    function blobToDataURL(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function extractTableAsArray(element) {
      const tableData = [];
      const table = element.querySelector('table');
      if (!table) return tableData;
      const rows = table.querySelectorAll('tr');
      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].querySelectorAll('td, th');
        const rowData = [];
        for (let j = 0; j < cells.length; j++) {
          let cellText = cells[j].textContent || cells[j].innerText || '';
          rowData.push(cellText.trim());
        }
        if (rowData.length > 0) tableData.push(rowData);
      }
      return tableData;
    }

    function saveFormData() {
      const form = document.getElementById('ijma-form');
      const formData = new FormData(form);
      const data = {};

      for (let [key, value] of formData.entries()) {
        if (data[key]) {
          if (Array.isArray(data[key])) data[key].push(value);
          else data[key] = [data[key], value];
        } else {
          data[key] = value;
        }
      }

      const contenteditables = {};
      document.querySelectorAll('[contenteditable="true"]').forEach(element => {
        const elementId = element.id;
        if (elementId) contenteditables[elementId] = element.innerHTML;
      });
      data['_contenteditables'] = contenteditables;

      document.querySelectorAll('input[type="hidden"]').forEach(input => {
        if (input.id && input.id.includes('_hidden')) data[input.id] = input.value;
      });

      data['_authorCount'] = authorCount;
      data['_tableCount'] = tableCount;
      data['_figureCount'] = figureCount;

      localStorage.setItem('ijma_form_data', JSON.stringify(data));
    }

    function loadFormData() {
      const savedData = localStorage.getItem('ijma_form_data');
      if (!savedData) return;

      try {
        const data = JSON.parse(savedData);

        if (data['_authorCount'] && data['_authorCount'] > 1) {
          while (authorCount < data['_authorCount']) addAuthor();
        }
        if (data['_tableCount'] && data['_tableCount'] > 1) {
          while (tableCount < data['_tableCount']) addTable();
        }
        if (data['_figureCount'] && data['_figureCount'] > 1) {
          while (figureCount < data['_figureCount']) addFigure();
        }

        setTimeout(() => {
          Object.keys(data).forEach(key => {
            if (key.startsWith('_')) return;
            const element = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
            if (element && element.tagName !== 'DIV') {
              element.value = Array.isArray(data[key]) ? data[key][0] : data[key];
            }
          });

          if (data['_contenteditables']) {
            Object.keys(data['_contenteditables']).forEach(elementId => {
              const element = document.getElementById(elementId);
              if (element && element.contentEditable === 'true') {
                element.innerHTML = data['_contenteditables'][elementId];
                autoResizeEditable(element);
                const hiddenInputId = elementId + '_hidden';
                const hiddenInput = document.getElementById(hiddenInputId);
                if (hiddenInput && data[hiddenInputId]) hiddenInput.value = data[hiddenInputId];
                setTimeout(() => updateHiddenInput(element), 100);
              }
            });
          }
        }, 600);
      } catch (e) {
        console.error('Error loading form data:', e);
      }
    }

    function clearForm() {
      if (confirm('Are you sure you want to clear all form data? This action cannot be undone.')) {
        localStorage.removeItem('ijma_form_data');
        location.reload();
      }
    }

    document.addEventListener('input', function () { saveFormData(); });
    document.addEventListener('paste', function () { setTimeout(saveFormData, 200); });
    document.addEventListener('keyup', function (e) { if (e.target.contentEditable === 'true') saveFormData(); });
    document.addEventListener('blur', function (e) {
      if (e.target.contentEditable === 'true' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') saveFormData();
    }, true);

    setInterval(saveFormData, 2000);

    // HTML scraper integration
    let scrapedData = null;

    async function parseHTMLPaste() {
      const htmlText = (document.getElementById('html_paste')?.value || '').trim();
      if (!htmlText) {
        setStatus('error', 'Please paste HTML before parsing.');
        return;
      }

      if (!window.pywebview || !window.pywebview.api || !window.pywebview.api.scrape_html_paste) {
        setStatus('error', 'Scraper API not available. Run via desktop launcher.');
        return;
      }

      setStatus('info', 'Parsing HTML...');
      try {
        const result = await window.pywebview.api.scrape_html_paste(htmlText);
        if (result.error) {
          setStatus('error', 'Scraper error: ' + result.error);
          return;
        }

        scrapedData = result;
        console.log('scrapedData', scrapedData);

        // Show corresponding author selection if there are multiple authors
        if (scrapedData.authors && scrapedData.authors.length > 1) {
          showCorrespondingAuthorSelection();
        } else {
          // Single author or no authors: apply directly
          applyScrapedData();
        }
      } catch (e) {
        setStatus('error', 'Parse failed: ' + (e?.message || String(e)));
      }
    }

    function showCorrespondingAuthorSelection() {
      const container = document.getElementById('corresponding-author-radios');
      container.innerHTML = '';

      scrapedData.authors.forEach((author, idx) => {
        const email = scrapedData.emails[idx] || '';
        const label = document.createElement('label');
        label.className = 'd-block mb-2';
        label.innerHTML = `
          <input type="radio" name="corresponding_author_idx" value="${idx}" ${idx === 0 ? 'checked' : ''}>
          ${author} ${email ? `(${email})` : ''}
        `;
        container.appendChild(label);
      });

      document.getElementById('corresponding-author-selection').style.display = 'block';
    }

    function applyScrapedData() {
      if (!scrapedData) return;

      // Find which author is selected as corresponding
      const radios = document.querySelectorAll('input[name="corresponding_author_idx"]');
      let correspondingIdx = 0;
      for (let i = 0; i < radios.length; i++) {
        if (radios[i].checked) {
          correspondingIdx = parseInt(radios[i].value, 10);
          break;
        }
      }

      // Reorder so corresponding author is first
      const authors = [...(scrapedData.authors || [])];
      const emails = [...(scrapedData.emails || [])];
      const affiliations = [...(scrapedData.affiliations || [])];

      if (correspondingIdx !== 0 && correspondingIdx < authors.length) {
        [authors[0], authors[correspondingIdx]] = [authors[correspondingIdx], authors[0]];
        [emails[0], emails[correspondingIdx]] = [emails[correspondingIdx], emails[0]];
        [affiliations[0], affiliations[correspondingIdx]] = [affiliations[correspondingIdx], affiliations[0]];
      }

      // Auto-populate fields
      document.getElementById('manuscript_code').value = scrapedData.code || '';
      document.getElementById('research_title').value = scrapedData.title || '';
      document.getElementById('receive_date').value = scrapedData.receive_date || '';
      document.getElementById('accept_date').value = scrapedData.accept_date || '';

      // Clear existing authors (except first one) and populate
      const authorsContainer = document.getElementById('authors-container');
      authorsContainer.innerHTML = '';
      authorCount = 0;

      authors.forEach((author, idx) => {
        authorCount++;
        const div = document.createElement('div');
        div.className = 'author-group mb-4 border rounded p-3';
        div.style.backgroundColor = '#fff';

        const removeBtn = (idx === 0) ? '' : `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAuthor(this)">Remove</button>`;

        div.innerHTML = `
          <h6 class="text-primary d-flex justify-content-between align-items-center">
            Author ${authorCount}
            ${removeBtn}
          </h6>
          <div class="row">
            <div class="col-md-4">
              <label for="author_name_${authorCount}" class="form-label">Author Name *</label>
              <input type="text" class="form-control" id="author_name_${authorCount}" name="author_name_${authorCount}" value="${author}" ${idx === 0 ? 'required' : ''}>
            </div>
            <div class="col-md-4">
              <label for="author_affiliation_${authorCount}" class="form-label">Affiliation</label>
              <textarea class="form-control" id="author_affiliation_${authorCount}" name="author_affiliation_${authorCount}" rows="2">${affiliations[idx] || ''}</textarea>
            </div>
            <div class="col-md-4">
              <label for="author_email_${authorCount}" class="form-label">Email ${idx === 0 ? '(Corresponding Author)' : ''}</label>
              <input type="email" class="form-control" id="author_email_${authorCount}" name="author_email_${authorCount}" value="${emails[idx] || ''}">
            </div>
          </div>
        `;
        authorsContainer.appendChild(div);
      });

      // Hide the scraper UI
      document.getElementById('corresponding-author-selection').style.display = 'none';
      document.getElementById('html_paste').value = '';

      setStatus('success', 'Form populated from HTML. Review and edit as needed.');
      saveFormData();
    }

    async function collectPayload() {
      // Ensure hidden inputs are up-to-date (including async image inlining)
      const contentAreas = Array.from(document.querySelectorAll('[contenteditable="true"]'));
      await Promise.all(contentAreas.map((el) => updateHiddenInput(el)));

      const payload = {
        title: (document.getElementById('research_title')?.value || '').trim(),
        research_type: (document.getElementById('research_type')?.value || '').trim(),
        receive_date: (document.getElementById('receive_date')?.value || '').trim(),
        accept_date: (document.getElementById('accept_date')?.value || '').trim(),
        abstract: (document.getElementById('abstract')?.value || '').trim(),
        keywords: (document.getElementById('keywords')?.value || '').trim(),
        introduction: (document.getElementById('introduction')?.value || '').trim(),
        aim_of_work: (document.getElementById('aim_of_work')?.value || '').trim(),
        patients_methods: (document.getElementById('patients_methods')?.value || '').trim(),
        results: (document.getElementById('results')?.value || '').trim(),
        discussion: (document.getElementById('discussion')?.value || '').trim(),
        references: (document.getElementById('references')?.value || '').trim(),
        authors: [],
        affiliations: [],
        email: '',
        tables: [],
        figures: []
      };

      // Authors
      const authorGroups = Array.from(document.querySelectorAll('.author-group'));
      authorGroups.forEach((group, idx) => {
        const name = group.querySelector('input[id^="author_name_"]')?.value?.trim() || '';
        const aff = group.querySelector('textarea[id^="author_affiliation_"]')?.value?.trim() || '';
        const emailField = group.querySelector('input[id^="author_email_"]');
        const emailVal = emailField ? (emailField.value || '').trim() : '';
        if (name) payload.authors.push(name);
        if (aff) payload.affiliations.push(aff);
        // Prefer first non-empty email as corresponding
        if (!payload.email && emailVal) payload.email = emailVal;
      });

      // Tables
      const tableGroups = Array.from(document.querySelectorAll('.table-group'));
      tableGroups.forEach((group) => {
        const info = group.querySelector('input[id^="table_info_"]')?.value?.trim() || '';
        const hidden = group.querySelector('input[type="hidden"][id^="table_content_"]');
        const content = hidden ? (hidden.value || '').trim() : '';
        if (info || content) payload.tables.push({ info, content });
      });

      // Figures
      const figureGroups = Array.from(document.querySelectorAll('.figure-group'));
      figureGroups.forEach((group) => {
        const info = group.querySelector('input[id^="figure_info_"]')?.value?.trim() || '';
        const hidden = group.querySelector('input[type="hidden"][id^="figure_content_"]');
        const content = hidden ? (hidden.value || '').trim() : '';
        if (info || content) payload.figures.push({ info, content });
      });

      return payload;
    }

    async function generateDocument() {
      const btn = document.getElementById('generate-btn');
      btn.disabled = true;

      try {
        const payload = await collectPayload();
        if (!payload.title) {
          setStatus('error', 'Research Title is required.');
          return;
        }
        if (!payload.authors.length) {
          setStatus('error', 'At least one Author Name is required.');
          return;
        }

        if (!window.pywebview || !window.pywebview.api) {
          setStatus('error', 'pywebview API is not available. Please run this UI via the desktop launcher.');
          return;
        }

        setStatus('info', 'Generating document...');
        const result = await window.pywebview.api.generate_document_with_save_dialog(payload);
        console.log('generate_document_with_save_dialog result:', result);

        if (result && result.saved_path) {
          setStatus('success', `Saved: <code>${result.saved_path}</code>`);
        } else if (result && result.cancelled) {
          setStatus('info', 'Save cancelled.');
        } else if (result && result.error) {
          setStatus('error', 'Document generation failed: ' + result.error);
        } else {
          setStatus('error', 'Document generation failed (no details).');
        }
      } catch (e) {
        console.error(e);
        setStatus('error', 'Document generation failed: ' + (e?.message || String(e)));
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
